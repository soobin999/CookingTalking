<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script type="text/javascript" src="/js/yujin/talk.js"></script>

<title>게시판 상세</title>
<script>
	$(function() {
		$('.comment-update-btn').on('click',function(e) {
			var text = $(e.target).closest('.comment-div').find(".comment-form").text();
			$(e.target).closest('.comment-div').find(".comment-form").html("<input type='text' name='ComCode' value='"+text+"' id='talkCom'>");
			$(e.target).closest('.comment-div').find(".comment-btn").html("<button type='button' class='btnDo'>수정하기</button>");
			updateResult();
		})
	})

	function updateResult() {
		$('.btnDo').on('click',function(e) {
			var item = $(e.target).closest('.comment-div').find('#talkCom').val();
			var text = $(e.target).closest('.comment-div').find('.comment-form').text(item);
			var comCode = $(e.target).closest('.comment-div').find('.comment-code').val();
			
			$(e.target).closest('.comment-div').find('.comment-btn').html("<button type='button' class='com_update'>수정</button>");

			// text -> DB에서 talkCom
			// comCode -> DB에서 talkComCode

			// UPDATE talkcom SET talkCom = #{talkCom} WHERE talkComCode = #{talkComCode}
			// var TalkcomC = $(e.target).attr('value')
			
			$.ajax({
				url : '/com/update/' + comCode,
				type : 'put',
				data : item
			}).done(function(result){
				if (result == "success") {
					alert("수정되었습니다");
					location.reload();
				}
			}).fail(function(){
				alert('comment update fail')
			})
		});
	}
	

	/* function newCom() {

		$(".btnDo").click(function(e) {
			var TalkcomC = $(e.target).attr('value')
		
			console.log(TalkcomC)

			$.ajax({
				url : '/com/update/' + TalkcomC,
				method : "PUT",
				data : {
					talkComCode : TalkcomC,
					talkCom : Talkcom
				},
				success : function(result) {
					if (result == "success") {
						alert("수정되었습니다");
						location.reload();
					}
				}
			})
		})
	}; */

	
</script>

</head>
<body th:object="${talkCode}">
	<h2>게시글 보기</h2>
	<form name="form1" method="post">
		<table border="1" width="900px">
			<thead>
				<tr>
					<th>내용</th>
					<th>아이디</th>
					<th>시간</th>
					<th>사진</th>
					<th>좋아요</th>
					<th>댓글</th>
				</tr>
			</thead>
			<tbody>
				<a th:href="@{/talk/list}"
					class="btn btn-default waves-effect waves-light">뒤로가기</a>

				<tr>
					<td th:text="${listCom.talkCont}"></td>
					<td th:text="${listCom.nickName}"></td>
					<td th:text="${listCom.talkDate}"></td>
					<td th:text="${listCom.talkVideo}"></td>
					<td th:text="${listCom.talkLike}"></td>
					<td th:text="${listCom.talkCom}"></td>
				</tr>
				</div>
			</tbody>
		</table>
		<div style="width: 650px; text-align: center;">
			<th:block sec:authorize="isAuthenticated()">
				<input id="talk-code" type="hidden" th:value="${listCom.talkCode}">

				<div th:if="${#authentication.principal.username} == *{userId}">
					<a th:href="@{/talk/updatePage(talkCode=${listCom.talkCode})}">수정</a>

					<button type="button" id="btnDelete">삭제</button>
				</div>
			</th:block>
			<!-- <span th:text="${#authentication.principal}"></span> -->
			</th:block>
		</div>

	</form>
	<br>

	<table>
		<div style="width: 650px; text-align: center;">
			<div class="box bpx-warning">
				<div class="box-header with-border">

					<a class="link-black text-lg"><i class="fa fa-pencil"></i>댓글작성</a>
				</div>
				<br>
				<!-- <tr th:if="${sessionScope.userId !=null}"> -->
				<textarea rows="5" cols="80" id="talk-comment"
					placeholder="댓글을 작성해주세요 "></textarea>
				<br>

				<button type="button" id="btn_comment">댓글작성</button>
				<br> <br>

				<div id="docs_comment_list_area">
					<div class="comment-div" th:each="com : ${listCom.talkComs}">
						<input class="comment-code" type="hidden"
							th:value="${com.talkComCode}">
							
							 <span th:text="${com.nickName}"></span> 
							 <span th:text="${com.talkCom}"class="comment-form"></span>

						<div th:if="${#authentication.principal.username} == ${com.userId}">

							<div class="comment-btn">

								<button class="comment-update-btn" type="button" id="com_update"
									th:value='${com.talkComCode}'>수정</button>

								<button class="comment-delete-btn" type="button" id="com_Delete"
									th:value='${com.talkComCode}'>삭제</button>
							</div>
						</div>
					</div>
				</div>
	</table>
	
	<!-- 	<th:block sec:authorize="isAuthenticated()">
		<input id="talkcom_code" type="hidden" th:value="${talkCode.talkCom}">
	
		<div th:if="${#authentication.principal.username} == ${.userId}">
		
			<button type="button" id="com_update" onclick="showUpdateCom($'com.talkCom')">수정</button>
			<button type="button" id="com_Delete">삭제</button>
		</div>
	</th:block>
 --> 
</body>
</html>